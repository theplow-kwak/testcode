# Build sequence

## Build with Makefile wrapper

```bash
make static
```

## Build with build.sh wrapper

build 전에 clean 상태로 만들기:

1. subprojects/ 폴더에서 packagefiles를 제외한 모든 folders 삭제

   ```bash
   find subprojects -mindepth 1 -maxdepth 1 -type d ! -name 'packagefiles' -exec rm -rf {} +
   ```

2. subprojects/openssl.wrap 파일 삭제

   ```bash
   rm subprojects/openssl.wrap
   ```

3. build 폴더 삭제

   ```bash
   rm -rf .build-ci/
   ```

static build:

- ```bash
  scripts/build.sh static
  ```

- debug build

  ```bash
  scripts/build.sh -b debug static
  ```

- source 수정 후 compile만 다시하고 싶을때

  ```bash
  ninja -C .build-ci/
  ```

## Build with meson

```bash
meson setup .build --buildtype=release --default-library=static \
-Dc_link_args="-static" --wrap-mode=forcefallback \
-Dlibnvme:tests=false -Dlibnvme:keyutils=disabled -Dlibnvme:liburing=enabled

ninja -C .build
```



# FDP

## QEMU Emulation Support

set the NVMe Subsystem

```
-device "nvme-subsys,id=nvme-subsys0,fdp=on,fdp.runs=96M,fdp.nrg=1,fdp.nruh=16"
```

set the NVMe namespace 

```
-drive "id=fdp-1,file=data.img,format=raw,if=none -device nvme-ns,id=fdp-1,drive=fdp1,nsid=1,fdp.ruhs=1-15"
```

qemu script:

```bash
cloud --bios -i oracular.qcow2 -u root -- nvme0:2 --fdp
```

## FDP Device Information

### Getting to know your FDP device

```bash
# FDP Device Configuration
sudo ./clive fdp configs /dev/nvme0 -e 1
# FDP Device Stats
sudo ./clive fdp stats /dev/nvme0 -e 1
# FDP Device Status
sudo ./clive fdp status /dev/nvme0 --namespace-id=1
# Querying FDP Events Generated by NVMe device
sudo ./clive fdp events /dev/nvme0 --endgrp-id=1
```

### Obtaining Device WAF using NVMe-CLI

```bash
sudo ./clive fdp stats /dev/nvme0 -e 1
sudo ./clive fdp stats /dev/nvme0 -e 1 | awk '/(HBMW)/ {hbmw = $7} /(MBMW)/ {mbmw = $7} END {print "Device WAF = " mbmw/hbmw}'
```



### Copy command

```bash
sudo ./clive copy /dev/nvme0n1 --format=0 --sdlba=0 --blocks=99 --slbs=200
```

 

## FDP enable

```bash
sudo ./clive delete-ns /dev/nvme0 -n 1
#Disable FDP
sudo ./clive fdp feature /dev/nvme0 -e 1 -d
sudo ./clive fdp feature /dev/nvme0 -e 1	# 확인
#enable FDP
sudo ./clive fdp feature /dev/nvme0 -e 1 -c 1
sudo ./clive fdp feature /dev/nvme0 -e 1
# Get capacity of drive and use it for further calculations
nsize=$(sudo ./clive id-ctrl /dev/nvme0 | grep unvmcap | sed "s/,//g" | awk '{print $3/4096}')
# Create namespace. use the capacity values from the above command in --nsze etc
sudo ./clive create-ns /dev/nvme0 -b 4096 --nsze=$nsize --ncap=$nsize -p 0,1,2,3 -n 4
#Attach namespace. Ex: NS id = 1, controller id = 0x7
sudo ./clive attach-ns /dev/nvme0 --namespace-id=1 --controllers=0x1
# Deallocate
sudo ./clive dsm /dev/nvme0n1 -n 1 -b $nsize
sudo ./clive fdp configs /dev/nvme0 -e 1
```


 1411  cloud --bios -i oracular.qcow2 -u root -- nvme0:2 --fdp 
 1434  sudo .build/clive fdp feature /dev/nvme0 
 1435  sudo .build/clive fdp feature /dev/nvme0 -e 1
 1436  sudo .build/clive fdp feature /dev/nvme0 -e 1 -d
 1437  sudo .build/clive fdp feature /dev/nvme0 -e 1 -c 1
 1650  sudo .build/clive fdp feature /dev/nvme0n1 -e 1
 1652  sudo .build/clive fdp copy /dev/nvme0n1 --sdlba=0 --blocks=25600 --slbs=100000,200000,300000,400000 --verbose --qdepth=10 --chunk=1
 1778  cloud --bios -i oracular.qcow2 -u root -- nvme0:2 --fdp 
 1791  qemu --bios --connect ssh --net bridge --uname root oracular.qcow2 nvme0:2 --fdp
